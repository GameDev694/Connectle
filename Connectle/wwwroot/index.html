<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@6.0.0/dist/browser/signalr.min.js"></script>
<script>
    // Ждем немного для загрузки SignalR
    setTimeout(() => {
        if (typeof signalR === 'undefined') {
            document.getElementById("status").textContent = "❌ SignalR не загружен - пробуем другой CDN";
            // Пробуем запасной CDN
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@microsoft/signalr@6.0.0/dist/browser/signalr.min.js';
            script.onload = initChat;
            document.head.appendChild(script);
        } else {
            initChat();
        }
    }, 100);

    function initChat() {
        console.log("✅ SignalR загружен");
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.on("ReceiveMessageHistory", (messages) => {
            console.log("История:", messages);
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = '';
            messages.forEach(msg => addMessageToChat(msg.user, msg.text, msg.timestamp));
            addMessageToChat("🤖 Система", "Добро пожаловать!", new Date());
        });

        connection.on("ReceiveMessage", (user, text, timestamp) => {
            addMessageToChat(user, text, timestamp);
        });

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            if (message) {
                connection.invoke("SendMessage", "Вы", message).catch(console.error);
                input.value = "";
            }
        }

        function sendCommand(command) {
            connection.invoke("SendMessage", "Вы", command).catch(console.error);
        }

        function addMessageToChat(user, text, timestamp) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.className = user.includes("Система") ? "message system" : "message";
            messageDiv.innerHTML = `<strong>${user}:</strong> ${text} <small>${new Date(timestamp).toLocaleTimeString()}</small>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById("messageInput").addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });

        connection.start()
            .then(() => {
                document.getElementById("status").textContent = "✅ Подключено!";
                document.getElementById("messageInput").disabled = false;
                document.getElementById("sendButton").disabled = false;
            })
            .catch(err => {
                document.getElementById("status").textContent = "❌ Ошибка: " + err;
            });
    }
</script>
